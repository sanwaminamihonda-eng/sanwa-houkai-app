# ADR-0001: データベースアーキテクチャ選定

## Status

**Accepted**

## Context

訪問介護記録アプリのデータベースアーキテクチャを選定する必要がある。

### 要件

- 利用者、職員、訪問記録、スケジュールなど複数のエンティティ管理
- 月次レポート、実績集計などの複雑なクエリ
- Google OAuth + Email/Password認証
- Vertex AI（Gemini）との連携
- GitHub ActionsによるCI/CD
- コストパフォーマンス重視

### 検討した選択肢

1. **Firestore単体**（NoSQL）
2. **Firestore + Firebase Data Connect**（ハイブリッド）
3. **Supabase + PowerSync**
4. **Firebase Data Connect単体**（PostgreSQL）

## Decision

**Firebase Data Connect単体**（Cloud SQL PostgreSQL）を採用する。

オフライン対応は行わない。

## Consequences

### メリット

1. **シンプルな構成**
   - DB一本で全データ管理
   - 同期ロジック不要
   - 運用・監視が容易

2. **データ整合性**
   - PostgreSQLのトランザクション
   - 外部キー制約
   - 常に最新データを参照

3. **柔軟な集計**
   - SQLによる複雑なクエリ
   - 月次レポート、実績集計が容易
   - ビュー、ストアドプロシージャ利用可能

4. **GCP統一**
   - Firebase Auth連携
   - Vertex AI連携
   - 課金一元管理

5. **コスト**
   - $9.37/月〜（Cloud SQL）
   - 3ヶ月無料トライアル

### デメリット

1. **オフライン非対応**
   - 電波のない場所では使用不可
   - 通信障害時は業務停止

2. **Data Connectの成熟度**
   - 2025年4月GA（比較的新しい）
   - 事例・ドキュメントがFirestoreより少ない

### オフライン対応を採用しなかった理由

| リスク | 影響 |
|--------|------|
| データの古いバージョンが使用される | スケジュール変更が反映されず誤訪問 |
| 同期コンフリクト | 同じ記録を複数人が編集した際のデータ破損 |
| アプリコードの古いバージョン | バグ修正・セキュリティパッチの即時反映不可 |
| 強制アップデート機構 | 追加実装コスト |
| デバッグ・テストの複雑化 | 品質担保が困難 |

これらのリスクは、オフライン対応のメリット（電波なしでも使用可能）を上回ると判断した。

### リスク軽減策

- 重要な操作前にオンライン確認を促すUI
- 通信エラー時の適切なエラーメッセージ
- 紙の予備運用手順の整備

## Alternatives

### 不採用: Firestore + Data Connect（ハイブリッド）

- オフライン対応可能だが同期ロジックが複雑
- 2つのDBの整合性管理が必要
- 成功確率が下がる（75%程度と推定）

### 不採用: Supabase + PowerSync

- オフライン対応可能で実績あり
- GCP統一を断念する必要がある
- Vertex AI連携が間接的になる

### 不採用: Firestore単体

- オフライン対応は標準機能
- NoSQLで複雑なリレーション・集計が困難
- 介護保険の月次報告書作成に不向き
