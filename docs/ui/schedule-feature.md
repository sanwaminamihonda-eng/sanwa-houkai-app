# スケジュール管理機能 仕様

## 概要

訪問介護のスケジュールを視覚的に管理する機能。Googleカレンダー風UIで、柔軟な操作性を提供。

## 要件

### 基本機能

| 機能 | 説明 | 優先度 |
|------|------|--------|
| カレンダー表示 | 日/週/月ビュー切り替え | P0 |
| 予定ブロック表示 | 利用者・時間・担当者を視覚化 | P0 |
| ドラッグ&ドロップ | 予定の移動（日時変更） | P0 |
| リサイズ | 予定の伸縮（時間変更） | P1 |
| 新規作成 | カレンダー上でクリック/タップ | P0 |
| リアルタイム同期 | 変更を他端末に即時反映 | P1 |

### 表示要素

```
┌─────────────────────────────────────────┐
│ 09:00  山田太郎（身体介護）             │
│        担当: 佐藤                       │
│ 10:00  ─────────────────────           │
└─────────────────────────────────────────┘
```

予定ブロックに表示する情報:
- 利用者名
- サービス種類（色分け）
- 担当者
- 時間帯

### 色分け（サービス種類）

| サービス | 色 |
|---------|-----|
| 身体介護 | Blue (#2196F3) |
| 生活援助 | Green (#4CAF50) |
| 自立支援 | Orange (#FF9800) |
| 複合 | Purple (#9C27B0) |

## UI設計

### 週表示（メイン）

```
┌────────────────────────────────────────────────────────────┐
│ ◀ 2026年1月 第2週 ▶            [日] [週] [月]    + 新規   │
├────────────────────────────────────────────────────────────┤
│      │ 月5日 │ 火6日 │ 水7日 │ 木8日 │ 金9日 │ 土10日│ 日11日│
├──────┼───────┼───────┼───────┼───────┼───────┼───────┼───────┤
│ 08:00│       │       │       │       │       │       │       │
├──────┼───────┼───────┼───────┼───────┼───────┼───────┼───────┤
│ 09:00│███████│       │███████│       │███████│       │       │
│      │山田   │       │山田   │       │山田   │       │       │
├──────┼───────┼───────┼───────┼───────┼───────┼───────┼───────┤
│ 10:00│       │███████│       │███████│       │       │       │
│      │       │鈴木   │       │鈴木   │       │       │       │
├──────┼───────┼───────┼───────┼───────┼───────┼───────┼───────┤
│ 11:00│       │       │       │       │       │       │       │
└──────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┘
```

### 日表示

```
┌────────────────────────────────────────┐
│ ◀ 2026年1月9日（木） ▶   [日] [週] [月]│
├────────────────────────────────────────┤
│ 08:00 │                                │
├───────┼────────────────────────────────┤
│ 09:00 │ ████████████████████████████   │
│       │ 山田太郎（身体介護）           │
│       │ 担当: 佐藤  09:00-10:00        │
├───────┼────────────────────────────────┤
│ 10:00 │ ████████████████████████████   │
│       │ 鈴木花子（生活援助）           │
│       │ 担当: 田中  10:00-11:30        │
├───────┼────────────────────────────────┤
│ 11:00 │ ████████████████              │
│       │                                │
└───────┴────────────────────────────────┘
```

### 月表示

```
┌──────────────────────────────────────────────────────────┐
│ ◀ 2026年1月 ▶                          [日] [週] [月]   │
├────────┬────────┬────────┬────────┬────────┬────────┬────────┤
│   月   │   火   │   水   │   木   │   金   │   土   │   日   │
├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
│        │        │   1    │   2    │   3    │   4    │   5    │
│        │        │ ●2件   │ ●3件   │ ●2件   │        │        │
├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
│   6    │   7    │   8    │   9    │  10    │  11    │  12    │
│ ●3件   │ ●2件   │ ●4件   │ ●3件   │ ●2件   │        │        │
└────────┴────────┴────────┴────────┴────────┴────────┴────────┘
```

## デバイス別操作

### デスクトップ / タブレット

| 操作 | アクション |
|------|-----------|
| ドラッグ | 予定を別の日時に移動 |
| 上下端ドラッグ | 予定の開始/終了時間を変更 |
| ダブルクリック | 予定詳細/編集モーダル |
| 空白クリック | 新規予定作成 |

### モバイル

| 操作 | アクション |
|------|-----------|
| タップ | 予定詳細表示 |
| ロングプレス | 編集モード（移動可能） |
| スワイプ | 日/週の移動 |
| FAB(+) | 新規予定作成 |

※モバイルではD&Dの精度が下がるため、編集モーダル経由を推奨

## 技術選定

### カレンダーライブラリ

| ライブラリ | Web | RN | D&D | 推奨 |
|-----------|-----|-----|-----|------|
| react-big-calendar | ✅ | ❌ | ✅ | Web用 |
| @fullcalendar/react | ✅ | ❌ | ✅ | Web用（高機能） |
| react-native-calendars | ❌ | ✅ | △ | RN用 |
| react-native-big-calendar | ❌ | ✅ | △ | RN用（週表示対応） |

**推奨構成:**
- **Web (Next.js)**: `@fullcalendar/react` + `@fullcalendar/interaction`
- **Mobile (RN)**: `react-native-big-calendar` または カスタム実装

### リアルタイム同期

| 方式 | 遅延 | コスト | 複雑度 | 推奨 |
|------|------|--------|--------|------|
| Firebase Realtime DB | 即時 | 低 | 低 | ✅ MVP |
| Firestore onSnapshot | 即時 | 中 | 低 | ✅ 推奨 |
| Cloud Pub/Sub + SSE | 即時 | 高 | 高 | 将来 |
| ポーリング（10秒） | 10秒 | 低 | 低 | 最小構成 |

**MVP推奨**: Firestoreのリアルタイムリスナー
- Firebase Data Connect（PostgreSQL）をマスターDB
- スケジュール変更時にFirestoreにも同期
- フロントはFirestoreをリッスン

```
[フロント] ←リアルタイム← [Firestore] ←同期← [Cloud SQL]
     ↓                                          ↑
     └──────────────── 更新 ────────────────────┘
```

## データモデル拡張

### schedules テーブル（拡張）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| client_id | UUID | FK: clients |
| staff_id | UUID | FK: staff |
| service_type_id | UUID | FK: service_types |
| scheduled_date | DATE | 予定日 |
| start_time | TIME | 開始時刻 |
| end_time | TIME | 終了時刻 |
| status | TEXT | scheduled / completed / cancelled |
| recurrence_rule | TEXT | 繰り返しルール（iCal RRULE形式） |
| recurrence_id | UUID | 繰り返しの親ID |
| notes | TEXT | メモ |
| created_at | TIMESTAMPTZ | 作成日時 |
| updated_at | TIMESTAMPTZ | 更新日時 |

### 繰り返し予定

定期訪問（毎週月・水・金など）の対応:

```
recurrence_rule: "FREQ=WEEKLY;BYDAY=MO,WE,FR"
```

- 繰り返しの1件を変更 → その日のみ変更（例外作成）
- 繰り返し全体を変更 → 親を更新

## ナビゲーション

### ボトムナビ更新

```
┌─────────┬─────────┬─────────┬─────────┬─────────┐
│  記録   │  履歴   │ 予定表  │ 利用者  │  その他  │
│   +     │   ⏱    │   📅    │   👤    │   ⋮    │
└─────────┴─────────┴─────────┴─────────┴─────────┘
                      ↑
                   NEW: スケジュール管理
```

「予定表」タップ → スケジュール管理画面（週表示デフォルト）

## 実装優先度

| Phase | 機能 | 優先度 |
|-------|------|--------|
| MVP | 週表示 + 予定一覧 | P0 |
| MVP | 予定の新規作成・編集 | P0 |
| MVP | 日/週/月切り替え | P0 |
| v1.1 | ドラッグ&ドロップ（Web） | P1 |
| v1.1 | リアルタイム同期 | P1 |
| v1.2 | 繰り返し予定 | P2 |
| v1.2 | 担当者別フィルタ | P2 |
| v1.3 | 利用者別表示 | P2 |
| v1.3 | 競合検知（ダブルブッキング警告） | P2 |
