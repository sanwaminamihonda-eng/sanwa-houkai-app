# アーキテクチャ設計

## 全体構成

```
┌─────────────────────────────────────────────────────────────────────┐
│                         クライアント層                               │
├─────────────────────────────────────────────────────────────────────┤
│   ┌─────────────────────┐      ┌─────────────────────┐             │
│   │  モバイルアプリ      │      │  Web管理画面        │             │
│   │  (React Native)     │      │  (Next.js)          │             │
│   └─────────┬───────────┘      └──────────┬──────────┘             │
│             └──────────────┬───────────────┘                        │
└────────────────────────────┼────────────────────────────────────────┘
                             │ HTTPS
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         Firebase 層                                  │
├─────────────────────────────────────────────────────────────────────┤
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  Firebase Auth  │  Data Connect (PostgreSQL)  │  Hosting    │   │
│   └─────────────────────────────────────────────────────────────┘   │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │                      Cloud Functions                         │   │
│   └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│              Vertex AI (Gemini 2.5 Flash / 日本リージョン)           │
└─────────────────────────────────────────────────────────────────────┘
```

## 技術スタック

| レイヤー | 技術 | 選定理由 |
|---------|------|---------|
| モバイル | React Native + Expo | クロスプラットフォーム、TypeScript |
| Web | Next.js | React、SSR/SSG、Firebase連携 |
| 認証 | Firebase Auth | Google OAuth + Email/PW |
| API | Firebase Data Connect | GraphQL、型安全SDK自動生成 |
| DB | Cloud SQL PostgreSQL | RDB、トランザクション、SQL集計 |
| ホスティング | Firebase Hosting | CDN、SSL自動、CI/CD連携 |
| 関数 | Cloud Functions | サーバーレス、イベント駆動 |
| AI | Vertex AI Gemini 2.5 Flash | 日本リージョン、低コスト |

## 設計方針

| 方針 | 内容 |
|------|------|
| **オンライン前提** | オフライン非対応（[ADR-0001](./adr/0001-database-architecture.md)参照） |
| **シングルDB** | PostgreSQL一本で全データ管理 |
| **GCP統一** | 認証・DB・AI全てGCP/Firebase |

## セキュリティ

| 項目 | 対応 |
|------|------|
| 認証 | Firebase Auth（トークンベース） |
| 認可 | Data Connectセキュリティルール、事業所単位のデータ分離 |
| 通信 | HTTPS、Firebase App Check |
| データ保護 | Cloud SQL暗号化、日次バックアップ |

## データフロー

```
【訪問記録入力】
  職員 → アプリ → Data Connect → PostgreSQL → Cloud Functions → Vertex AI

【スケジュール確認】
  職員 → アプリ → Data Connect → PostgreSQL（最新データ即時取得）

【月次レポート】
  管理者 → Web → Data Connect → PostgreSQL（SQL集計）→ PDF出力
```

## コスト見積もり（月額・小規模）

| サービス | 想定コスト |
|---------|-----------|
| Cloud SQL PostgreSQL | $9.37〜 |
| Data Connect | $0〜4 |
| Firebase Auth/Hosting | $0（無料枠内） |
| Vertex AI | $5〜20 |
| **合計** | **$15〜35** |

## 運用

| 項目 | 内容 |
|------|------|
| CI/CD | GitHub Actions → Firebase Deploy |
| 監視 | Cloud Monitoring、Error Reporting |
| バックアップ | Cloud SQL日次自動（7日保持） |
